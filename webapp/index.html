<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Protein Folding Visualizer</title>
    <script src="https://3Dmol.org/build/3Dmol-min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        
        h1 { color: #333; margin-bottom: 10px; }
        .subtitle { color: #666; margin-bottom: 30px; }
        
        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-family: monospace;
            font-size: 13px;
            resize: vertical;
            min-height: 100px;
        }
        
        textarea:focus { outline: none; border-color: #667eea; }
        
        .info { display: flex; justify-content: space-between; margin: 10px 0; font-size: 14px; color: #666; }
        
        .badge { padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600; }
        .badge.valid { background: #d1fae5; color: #065f46; }
        .badge.invalid { background: #fee2e2; color: #991b1b; }
        .badge.processing { background: #fef3c7; color: #92400e; }
        .badge.completed { background: #d1fae5; color: #065f46; }
        
        button {
            width: 100%; padding: 14px; background: #667eea; color: white;
            border: none; border-radius: 6px; font-size: 16px; font-weight: 600;
            cursor: pointer; margin-top: 10px; transition: all 0.3s;
        }
        button:hover:not(:disabled) { background: #5568d3; transform: translateY(-1px); }
        button:disabled { background: #ccc; cursor: not-allowed; }
        
        .status-card {
            background: #f9fafb; padding: 20px; border-radius: 8px;
            margin-top: 20px; display: none;
        }
        .status-card.show { display: block; }
        
        .progress-bar {
            width: 100%; height: 6px; background: #e0e0e0;
            border-radius: 3px; overflow: hidden; margin: 10px 0;
        }
        .progress-fill {
            height: 100%; background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%; transition: width 0.5s;
        }

        /* Styles pour le visualiseur */
        .viewer-container {
            margin-top: 30px;
            display: none; /* CachÃ© par dÃ©faut */
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
        }
        .viewer-container.show { display: block; }
        
        #mol-viewer {
            width: 100%;
            height: 500px;
            background: white;
            position: relative;
        }

        .controls {
            padding: 15px;
            background: #f8f9fa;
            border-top: 1px solid #ddd;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        input[type=range] {
            flex-grow: 1;
            cursor: pointer;
        }

        .step-label {
            font-weight: bold;
            min-width: 80px;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ§¬ Protein Folding Visualizer</h1>
        <p class="subtitle">PrÃ©diction de structure avec ESMFold</p>
        
        <textarea id="sequence" placeholder="Collez votre sÃ©quence ici... Exemple: MPGWFKKAWYGLASLLSFSSFILII"></textarea>
        
        <div class="info">
            <span id="length">Longueur: 0 aa</span>
            <span id="valid" class="badge"></span>
        </div>
        
        <button id="foldBtn" disabled>ðŸš€ Lancer le repliement</button>
        
        <div id="statusCard" class="status-card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <strong>Job ID: <span id="jobId">-</span></strong>
                <span id="statusBadge" class="badge processing">En cours</span>
            </div>
            <div class="progress-bar">
                <div id="progressFill" class="progress-fill"></div>
            </div>
            <p id="progressText" style="font-size: 14px; color: #666;">Initialisation...</p>
        </div>
        
        <div id="viewerSection" class="viewer-container">
            <div id="mol-viewer"></div>
            <div class="controls">
                <button id="playBtn" style="width: auto; padding: 8px 15px; margin: 0;">â–¶</button>
                <span class="step-label" id="stepLabel">Etape 0</span>
                <input type="range" id="stepSlider" min="0" max="0" value="0" step="1">
            </div>
        </div>
    </div>
    
    <script>
        const API_URL = 'http://localhost:8000/api';
        
        // Ã‰lÃ©ments DOM
        const sequenceInput = document.getElementById('sequence');
        const lengthDisplay = document.getElementById('length');
        const validDisplay = document.getElementById('valid');
        const foldBtn = document.getElementById('foldBtn');
        const statusCard = document.getElementById('statusCard');
        const jobIdDisplay = document.getElementById('jobId');
        const statusBadge = document.getElementById('statusBadge');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const viewerSection = document.getElementById('viewerSection');
        const stepSlider = document.getElementById('stepSlider');
        const stepLabel = document.getElementById('stepLabel');
        const playBtn = document.getElementById('playBtn');
        
        let currentJobId = null;
        let jobResults = null;
        let viewer = null;
        let isPlaying = false;
        
        // Initialisation du viewer 3Dmol
        function initViewer() {
            if (!viewer) {
                viewer = $3Dmol.createViewer(document.getElementById('mol-viewer'), {
                    backgroundColor: 'white'
                });
            }
        }

        // Chargement d'une Ã©tape spÃ©cifique
        async function loadStep(stepIndex) {
            if (!jobResults || !jobResults.steps[stepIndex]) return;

            const pdbUrl = jobResults.steps[stepIndex].pdb_url;
            
            // On rÃ©cupÃ¨re le contenu du PDB
            // Note: on ajoute l'URL complÃ¨te si besoin
            const response = await fetch(`http://localhost:8000${pdbUrl}`);
            const pdbData = await response.text();

            viewer.clear();
            viewer.addModel(pdbData, "pdb");
            viewer.setStyle({}, {cartoon: {color: 'spectrum'}});
            viewer.zoomTo();
            viewer.render();

            // Mise Ã  jour UI
            stepLabel.textContent = `Etape ${stepIndex + 1}/${jobResults.steps.length}`;
        }

        // Gestion du Slider
        stepSlider.addEventListener('input', (e) => {
            const step = parseInt(e.target.value);
            loadStep(step);
        });

        // Gestion du bouton Play
        playBtn.addEventListener('click', () => {
            isPlaying = !isPlaying;
            playBtn.textContent = isPlaying ? 'â¸' : 'â–¶';
            
            if (isPlaying) {
                playAnimation();
            }
        });

        function playAnimation() {
            if (!isPlaying) return;
            
            let current = parseInt(stepSlider.value);
            let next = current + 1;
            
            if (next >= jobResults.steps.length) next = 0; // Boucle
            
            stepSlider.value = next;
            loadStep(next);
            
            setTimeout(playAnimation, 500); // Vitesse de l'animation
        }

        // Validation en temps rÃ©el
        sequenceInput.addEventListener('input', () => {
            const seq = cleanSequence(sequenceInput.value);
            lengthDisplay.textContent = `Longueur: ${seq.length} aa`;
            
            if (seq.length === 0) {
                validDisplay.textContent = '';
                validDisplay.className = 'badge';
                foldBtn.disabled = true;
            } else if (isValid(seq) && seq.length >= 10 && seq.length <= 1000) {
                validDisplay.textContent = 'âœ“ Valide';
                validDisplay.className = 'badge valid';
                foldBtn.disabled = false;
            } else {
                validDisplay.textContent = 'âœ— Invalide';
                validDisplay.className = 'badge invalid';
                foldBtn.disabled = true;
            }
        });
        
        // Lancer le folding
        foldBtn.addEventListener('click', async () => {
            const sequence = cleanSequence(sequenceInput.value);
            foldBtn.disabled = true;
            foldBtn.textContent = 'â³ Lancement...';
            viewerSection.classList.remove('show');
            
            try {
                const response = await fetch(`${API_URL}/fold`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sequence })
                });
                
                const data = await response.json();
                if(data.status === "exists") {
                     // Si le job existe dÃ©jÃ , on passe directement aux rÃ©sultats
                     currentJobId = data.job_id;
                     loadResults();
                } else {
                    currentJobId = data.job_id;
                    jobIdDisplay.textContent = currentJobId;
                    statusCard.classList.add('show');
                    pollStatus();
                }

            } catch (error) {
                alert('Erreur: ' + error.message);
                foldBtn.disabled = false;
                foldBtn.textContent = 'ðŸš€ Lancer le repliement';
            }
        });
        
        async function pollStatus() {
            const interval = setInterval(async () => {
                try {
                    const response = await fetch(`${API_URL}/status/${currentJobId}`);
                    const status = await response.json();
                    
                    const percent = (status.progress / status.total_steps) * 100;
                    progressFill.style.width = `${percent}%`;
                    progressText.textContent = `Ã‰tape ${status.progress}/${status.total_steps}`;
                    
                    if (status.status === 'completed') {
                        clearInterval(interval);
                        statusBadge.textContent = 'âœ“ TerminÃ©';
                        statusBadge.className = 'badge completed';
                        loadResults();
                    } else if (status.status === 'failed') {
                        clearInterval(interval);
                        statusBadge.textContent = 'âœ— Ã‰chec';
                        statusBadge.className = 'badge invalid';
                        foldBtn.disabled = false;
                        foldBtn.textContent = 'ðŸš€ Lancer le repliement';
                    }
                } catch (error) { console.error(error); }
            }, 2000);
        }
        
        async function loadResults() {
            try {
                const response = await fetch(`${API_URL}/results/${currentJobId}`);
                jobResults = await response.json();
                
                // PrÃ©parer la visualisation
                initViewer();
                viewerSection.classList.add('show');
                
                // Configurer le slider
                stepSlider.max = jobResults.steps.length - 1;
                stepSlider.value = jobResults.steps.length - 1; // Aller Ã  la fin directement
                
                // Charger la structure finale
                loadStep(jobResults.steps.length - 1);
                
                // RÃ©activer le bouton
                foldBtn.disabled = false;
                foldBtn.textContent = 'ðŸš€ Lancer le repliement';
                
                // Scroller vers le viewer
                setTimeout(() => viewerSection.scrollIntoView({behavior: 'smooth'}), 100);

            } catch (error) { console.error('Erreur rÃ©sultats:', error); }
        }
        
        function cleanSequence(seq) { return seq.toUpperCase().replace(/[^A-Z]/g, ''); }
        function isValid(seq) { return /^[ACDEFGHIKLMNPQRSTVWY]+$/.test(seq); }
    </script>
</body>
</html>